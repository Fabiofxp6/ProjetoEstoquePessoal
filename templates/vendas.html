{% extends 'base.html' %}
{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white"><h5>Nova Venda</h5></div>
            <div class="card-body">
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-6">
                        <label>Selecionar Produto</label>
                        <select id="product-select" class="form-select">
                            <option value="">Selecione...</option>
                            {% for p in produtos %}
                            <option value="{{ p._id }}" data-price="{{ p.preco_venda }}" data-stock="{{ p.quantidade }}">
                                {{ p.modelo }} (Estoque: {{ p.quantidade }}) - R$ {{ p.preco_venda }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Qtd</label>
                        <input type="number" id="qty-input" class="form-control" value="1" min="1">
                    </div>
                    <div class="col-md-3">
                        <button type="button" onclick="addItem()" class="btn btn-success w-100"><i class="fa fa-plus"></i> Add</button>
                    </div>
                </div>

                <form action="{{ url_for('sales.process_sale') }}" method="POST">
                    <table class="table" id="cart-table">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Preço Unit.</th>
                                <th>Qtd</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cart-body">
                            </tbody>
                    </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <h3 class="text-muted">Total</h3>
                <h1 id="total-display">R$ 0,00</h1>
                <hr>
                <label class="form-label">Forma de Pagamento</label>
                <select name="payment_method" class="form-select mb-3" required>
                    <option value="Pix">Pix</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Debito">Débito</option>
                    <option value="Credito">Crédito</option>
                </select>
                <button type="submit" class="btn btn-primary btn-lg w-100">Finalizar Venda</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let totalGeral = 0;

// Função para atualizar o texto do total na tela
function atualizarDisplay() {
    // Garante que o total não fique negativo por erros de arredondamento
    if (totalGeral < 0) totalGeral = 0;
    document.getElementById('total-display').innerText = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
}

function addItem() {
    const select = document.getElementById('product-select');
    const qtyInput = document.getElementById('qty-input');
    const option = select.options[select.selectedIndex];
    
    if (!option.value) {
        alert("Por favor, selecione um produto.");
        return;
    }

    const id = option.value;
    const name = option.text.split(' (')[0]; // Pega apenas o nome do modelo
    const price = parseFloat(option.getAttribute('data-price'));
    const stock = parseInt(option.getAttribute('data-stock'));
    const qty = parseInt(qtyInput.value);

    // Validação básica
    if (qty <= 0) {
        alert("A quantidade deve ser pelo menos 1.");
        return;
    }
    if (qty > stock) {
        alert("Quantidade insuficiente em estoque!");
        return;
    }

    const subtotal = price * qty;
    totalGeral += subtotal;

    // Criamos a linha da tabela
    const row = `
        <tr>
            <td>${name} <input type="hidden" name="product_id[]" value="${id}"></td>
            <td>R$ ${price.toFixed(2)}</td>
            <td>${qty} <input type="hidden" name="quantity[]" value="${qty}"></td>
            <td class="item-subtotal">R$ ${subtotal.toFixed(2)}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" 
                        onclick="removeItem(this, ${subtotal})">
                    <i class="fa fa-trash"></i>
                </button>
            </td>
        </tr>
    `;

    document.getElementById('cart-body').insertAdjacentHTML('beforeend', row);
    atualizarDisplay();
    
    // Limpa a seleção para a próxima adição
    select.selectedIndex = 0;
    qtyInput.value = 1;
}

// Função para remover o item e subtrair o valor
function removeItem(btn, valorParaSubtrair) {
    // Remove a linha da tabela
    const row = btn.closest('tr');
    row.remove();

    // Subtrai o valor do total geral
    totalGeral -= valorParaSubtrair;
    
    // Atualiza o valor na tela
    atualizarDisplay();
}
</script>
{% endblock %}